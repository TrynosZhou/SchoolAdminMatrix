<div class="form-container">
  <div class="form-header">
    <div class="header-content">
      <h1>
        <span class="icon">ğŸ‘¨â€ğŸ“</span>
        {{ isEdit ? 'Edit Student' : 'Register New Student' }}
      </h1>
      <p class="subtitle">{{ isEdit ? 'Update student information' : 'Fill in the details to register and enroll a new student' }}</p>
    </div>
    <div class="header-actions">
      <button type="button" class="btn btn-secondary" (click)="router.navigate(['/students'])">
        <span>â†</span> Back to Students
      </button>
    </div>
  </div>

  <!-- Alert Messages -->
  <div class="alert alert-success" *ngIf="success">
    <span class="alert-icon">âœ“</span>
    {{ success }}
  </div>
  <div class="alert alert-error" *ngIf="error">
    <span class="alert-icon">âš </span>
    {{ error }}
  </div>

  <form (ngSubmit)="onSubmit()" #studentForm="ngForm" class="student-form">
    <!-- Personal Information Section -->
    <div class="form-section">
      <div class="section-header">
        <h2>
          <span class="section-icon">ğŸ‘¤</span>
          Personal Information
        </h2>
        <p class="section-description">Basic details about the student</p>
      </div>
      
      <!-- Photo Upload Section -->
      <div class="form-group full-width" style="margin-bottom: 20px;">
        <label for="photo">
          <span class="section-icon">ğŸ“·</span>
          Passport Size Photo <span class="optional">(Optional)</span>
        </label>
        <div style="display: flex; gap: 20px; align-items: flex-start;">
          <div style="flex: 1;">
            <input 
              type="file" 
              id="photo"
              accept="image/*"
              (change)="onPhotoSelected($event)"
              class="form-input"
              style="padding: 10px;">
            <small class="form-hint">Upload a passport-size photo (max 2MB, JPG/PNG)</small>
          </div>
          <div *ngIf="photoPreview" style="position: relative;">
            <img [src]="photoPreview" 
                 alt="Photo preview" 
                 style="width: 120px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
            <button type="button" 
                    (click)="removePhoto()" 
                    style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">
              Ã—
            </button>
          </div>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="firstName">
            First Name <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="firstName"
            [(ngModel)]="student.firstName" 
            name="firstName" 
            required
            placeholder="Enter first name"
            class="form-input"
            [class.error]="studentForm.submitted && !student.firstName">
          <small class="form-hint">Student's first name</small>
        </div>

        <div class="form-group">
          <label for="lastName">
            Last Name <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="lastName"
            [(ngModel)]="student.lastName" 
            name="lastName" 
            required
            placeholder="Enter last name"
            class="form-input"
            [class.error]="studentForm.submitted && !student.lastName">
          <small class="form-hint">Student's last name</small>
        </div>

        <div class="form-group">
          <label for="dateOfBirth">
            Date of Birth <span class="required">*</span>
          </label>
          <input 
            type="date" 
            id="dateOfBirth"
            [(ngModel)]="student.dateOfBirth" 
            name="dateOfBirth"
            required
            class="form-input"
            [max]="maxDate"
            [class.error]="studentForm.submitted && !student.dateOfBirth">
          <small class="form-hint">Select date of birth</small>
        </div>

        <div class="form-group">
          <label for="gender">
            Gender <span class="required">*</span>
          </label>
          <select 
            id="gender"
            [(ngModel)]="student.gender" 
            name="gender" 
            required
            class="form-input"
            [class.error]="studentForm.submitted && !student.gender">
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
          <small class="form-hint">Student's gender</small>
        </div>
      </div>
    </div>

    <!-- Contact Information Section -->
    <div class="form-section">
      <div class="section-header">
        <h2>
          <span class="section-icon">ğŸ“</span>
          Contact Information
        </h2>
        <p class="section-description">Contact details and address</p>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="contactNumber">
            Contact Number <span class="required">*</span>
          </label>
          <input 
            type="tel" 
            id="contactNumber"
            [(ngModel)]="student.contactNumber" 
            name="contactNumber"
            required
            placeholder="e.g., +254 712 345 678"
            class="form-input"
            pattern="[0-9+\s\-()]+"
            [class.error]="studentForm.submitted && !student.contactNumber">
          <small class="form-hint">Primary contact number</small>
        </div>

        <div class="form-group">
          <label for="phoneNumber">Phone Number (Optional)</label>
          <input 
            type="tel" 
            id="phoneNumber"
            [(ngModel)]="student.phoneNumber" 
            name="phoneNumber"
            placeholder="e.g., +254 712 345 678"
            class="form-input"
            pattern="[0-9+\s\-()]+">
          <small class="form-hint">Alternative phone number</small>
        </div>
      </div>

      <div class="form-group full-width">
        <label for="address">Address</label>
        <textarea 
          id="address"
          [(ngModel)]="student.address" 
          name="address"
          placeholder="Enter residential address"
          class="form-input"
          rows="3"></textarea>
        <small class="form-hint">Residential or postal address</small>
      </div>
    </div>

    <!-- Student Information Section -->
    <div class="form-section">
      <div class="section-header">
        <h2>
          <span class="section-icon">ğŸ†”</span>
          Student Information
        </h2>
        <p class="section-description">Student identification and type</p>
      </div>

      <div class="form-group">
        <label>Student Number</label>
        <div class="info-box">
          <div class="info-content">
            <span class="info-icon">ğŸ”¢</span>
            <div>
              <strong *ngIf="isEdit">{{ student.studentNumber }}</strong>
              <strong *ngIf="!isEdit">Auto-generated ({{ studentIdPrefix }} format)</strong>
              <p class="info-text">
                {{ isEdit 
                  ? 'Student number cannot be changed' 
                  : ('A unique 7-digit number with prefix ' + studentIdPrefix + ' will be automatically generated (e.g., ' + studentIdPrefix + '1234567)') }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="studentType">
            Student Type <span class="required">*</span>
          </label>
          <select 
            id="studentType"
            [(ngModel)]="student.studentType" 
            name="studentType" 
            required
            class="form-input"
            [class.error]="studentForm.submitted && !student.studentType">
            <option value="">Select Type</option>
            <option value="Day Scholar">Day Scholar</option>
            <option value="Boarder">Boarder</option>
          </select>
          <small class="form-hint">Select whether student is a Day Scholar or Boarder</small>
        </div>

        <div class="form-group" *ngIf="student.studentType">
          <label>Student Type Info</label>
          <div class="type-info-box" [class.day-scholar]="student.studentType === 'Day Scholar'" [class.boarder]="student.studentType === 'Boarder'">
            <span class="type-icon">{{ student.studentType === 'Day Scholar' ? 'ğŸ ' : 'ğŸ«' }}</span>
            <div>
              <strong>{{ student.studentType }}</strong>
              <p>{{ student.studentType === 'Day Scholar' ? 'Student attends school during the day and returns home' : 'Student resides at the school boarding facility' }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Staff Child Checkbox -->
      <div class="form-group full-width" style="margin-top: 20px;">
        <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px; border: 2px solid #4a90e2; border-radius: 6px; background: #f0f7ff;">
          <input 
            type="checkbox" 
            [(ngModel)]="student.isStaffChild" 
            name="isStaffChild"
            (change)="onStaffChildChange()"
            style="width: 18px; height: 18px; cursor: pointer;">
          <span style="font-weight: 600; color: #2c5aa0;">ğŸ‘¨â€ğŸ« Staff Child</span>
          <small style="color: #666; margin-left: 5px;">(Staff children don't pay tuition fees, pay 50% of DH meal fees, and don't pay transport costs)</small>
        </label>
      </div>

      <!-- Day Scholar Services (only show for Day Scholars) -->
      <div *ngIf="student.studentType === 'Day Scholar'" class="form-group full-width" style="margin-top: 20px;">
        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Additional Services (Day Scholars)</label>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
          <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;">
            <input 
              type="checkbox" 
              [(ngModel)]="student.usesTransport" 
              name="usesTransport"
              [disabled]="student.isStaffChild"
              style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-weight: 500;">ğŸšŒ School Transport</span>
            <small style="color: #666; margin-left: 5px;">(Additional cost applies{{ student.isStaffChild ? ' - Free for staff children' : '' }})</small>
          </label>
          <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;">
            <input 
              type="checkbox" 
              [(ngModel)]="student.usesDiningHall" 
              name="usesDiningHall"
              style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-weight: 500;">ğŸ½ï¸ Dining Hall (DH) Meals</span>
            <small style="color: #666; margin-left: 5px;">({{ student.isStaffChild ? '50% cost for staff children' : 'Additional cost applies' }})</small>
          </label>
        </div>
        <small class="form-hint" style="margin-top: 8px; display: block;">
          Select if the day scholar student uses school transport and/or dining hall meals. These services will be included in invoice calculations.
        </small>
      </div>
    </div>

    <!-- Enrollment Section -->
    <div class="form-section">
      <div class="section-header">
        <h2>
          <span class="section-icon">ğŸ“š</span>
          Class Enrollment
        </h2>
        <p class="section-description">Select the class for student enrollment</p>
      </div>

      <div class="form-group">
        <label for="classSearch">
          Class <span class="required">*</span>
          <span class="badge" *ngIf="student.classId">Selected</span>
        </label>
        <div class="search-box">
          <input 
            type="text" 
            id="classSearch"
            [(ngModel)]="classSearchQuery" 
            name="classSearch"
            placeholder="Search classes..."
            class="search-input"
            (input)="filterClasses()"
            [class.error]="studentForm.submitted && !student.classId">
          <span class="search-icon">ğŸ”</span>
        </div>
        <div class="class-selector" *ngIf="filteredClasses.length > 0">
          <div 
            *ngFor="let cls of filteredClasses" 
            class="class-option"
            [class.selected]="student.classId === cls.id"
            (click)="selectClass(cls.id)">
            <div class="class-option-content">
              <span class="class-icon">ğŸ“–</span>
              <div class="class-details">
                <strong>{{ cls.name }}</strong>
                <small *ngIf="cls.level">Level: {{ cls.level }}</small>
              </div>
              <span class="check-icon" *ngIf="student.classId === cls.id">âœ“</span>
            </div>
          </div>
        </div>
        <div class="empty-state" *ngIf="filteredClasses.length === 0 && classes.length > 0">
          <p>No classes found. Try a different search term.</p>
        </div>
        <div class="empty-state" *ngIf="classes.length === 0">
          <p>No classes available. Please create classes first.</p>
        </div>
        <small class="form-hint" *ngIf="!isEdit">Student will be automatically enrolled in the selected class</small>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="form-actions">
      <button 
        type="button" 
        class="btn btn-secondary" 
        (click)="router.navigate(['/students'])">
        <span>âŒ</span> Cancel
      </button>
      <button 
        type="submit" 
        class="btn btn-primary"
        [disabled]="submitting">
        <span *ngIf="!submitting">{{ isEdit ? 'ğŸ’¾' : 'â•' }}</span>
        <span *ngIf="submitting" class="spinner"></span>
        {{ submitting ? 'Processing...' : (isEdit ? 'Update Student' : 'Register Student') }}
      </button>
    </div>
  </form>
</div>
