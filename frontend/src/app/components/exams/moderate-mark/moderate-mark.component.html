<div class="moderate-mark-container">
  <div class="header">
    <h2>Moderate Mark</h2>
    <p class="subtitle">Adjust raw marks to create a uniform distribution</p>
  </div>

  <div class="selection-form" *ngIf="!moderatedData">
    <div class="form-row-single">
      <div class="form-group">
        <label for="classSelect">Class *</label>
        <select id="classSelect" [(ngModel)]="selectedClassId" (change)="onClassChange()" class="form-control">
          <option value="">Select Class</option>
          <option *ngFor="let cls of classes" [value]="cls.id">{{ cls.name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="examTypeSelect">Exam Type *</label>
        <select id="examTypeSelect" [(ngModel)]="selectedExamType" (change)="onExamTypeChange()" class="form-control" [disabled]="!selectedClassId">
          <option value="">Select Exam Type</option>
          <option *ngFor="let type of examTypes" [value]="type.value">{{ type.label }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="subjectSelect">Subject *</label>
        <select id="subjectSelect" [(ngModel)]="selectedSubjectId" (change)="onSubjectChange()" class="form-control" [disabled]="!selectedClassId">
          <option value="">Select Subject</option>
          <option *ngFor="let subject of subjects" [value]="subject.id">
            {{ subject.displayName || (subject.code ? subject.code + ' - ' + subject.name : subject.name) }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="termInput">Term</label>
        <input
          type="text"
          id="termInput"
          [(ngModel)]="selectedTerm"
          class="form-control"
          readonly
          title="Term is automatically set from system settings">
        <small class="text-muted">Term is automatically set from system settings</small>
      </div>
    </div>

    <div class="form-row-targets">
      <div class="form-group">
        <label for="targetMinInput">Target Minimum % *</label>
        <input
          type="number"
          id="targetMinInput"
          [(ngModel)]="targetMin"
          class="form-control"
          min="0"
          max="100"
          step="1"
          required>
        <small class="text-muted">Minimum moderated mark (default: 30)</small>
      </div>

      <div class="form-group">
        <label for="targetMaxInput">Target Maximum % *</label>
        <input
          type="number"
          id="targetMaxInput"
          [(ngModel)]="targetMax"
          class="form-control"
          min="0"
          max="100"
          step="1"
          required>
        <small class="text-muted">Maximum moderated mark (default: 90)</small>
      </div>
    </div>

    <div class="form-actions">
      <button 
        type="button" 
        class="btn btn-primary" 
        (click)="moderateMarks()" 
        [disabled]="loading || !selectedClassId || !selectedSubjectId || !selectedExamType || !targetMin || !targetMax || targetMin >= targetMax">
        <span *ngIf="loading">Processing...</span>
        <span *ngIf="!loading">Moderate Marks</span>
      </button>
    </div>
  </div>

  <div class="alert alert-danger" *ngIf="error">
    {{ error }}
  </div>

  <div class="alert alert-success" *ngIf="success">
    {{ success }}
  </div>

  <div class="results-section" *ngIf="moderatedData">
    <!-- Distribution Chart -->
    <div class="chart-container">
      <canvas #distributionChart></canvas>
    </div>

    <div class="results-header">
      <div class="results-info">
        <h3>Moderated Marks Results</h3>
        <div class="info-grid">
          <div class="info-item">
            <strong>School:</strong> {{ moderatedData.schoolName }}
          </div>
          <div class="info-item">
            <strong>Subject:</strong> {{ moderatedData.subject }}
          </div>
          <div class="info-item">
            <strong>Subject Teacher:</strong> {{ moderatedData.subjectTeacher }}
          </div>
          <div class="info-item">
            <strong>Exam Type:</strong> {{ moderatedData.examType }}
          </div>
          <div class="info-item" *ngIf="moderatedData.term">
            <strong>Term:</strong> {{ moderatedData.term }}
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button type="button" class="btn btn-primary" (click)="saveMarks()" [disabled]="savingMarks || !moderatedData || !moderatedData.results || moderatedData.results.length === 0">
          <span *ngIf="!savingMarks">üíæ</span>
          <span *ngIf="savingMarks" class="spinner-small"></span>
          {{ savingMarks ? 'Saving...' : 'Save Marks' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="printTable()">
          <span>üñ®Ô∏è</span> Print
        </button>
        <button type="button" class="btn btn-success" (click)="downloadExcel()">
          <span>üì•</span> Download CSV
        </button>
        <button type="button" class="btn btn-outline" (click)="moderatedData = null">
          <span>‚Ü©Ô∏è</span> New Selection
        </button>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="moderated-marks-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Student ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Raw Mark %</th>
            <th>Uniform Mark %</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let result of moderatedData.results; let i = index">
            <td>{{ i + 1 }}</td>
            <td><strong>{{ result.studentNumber }}</strong></td>
            <td>{{ result.firstName }}</td>
            <td>{{ result.lastName }}</td>
            <td>{{ result.rawMark }}%</td>
            <td><strong class="uniform-mark">{{ result.uniformMark }}%</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

