<div class="container">
  <div class="report-card-wrapper">
    <!-- Header Section -->
    <div class="form-header">
      <div class="header-content">
        <h1>
          <span class="icon">üìä</span>
          Report Cards
        </h1>
        <p class="subtitle">Generate and view student report cards</p>
      </div>
    </div>

    <!-- Alert Messages -->
    <div class="alert alert-success" *ngIf="success" [@fadeInOut]>
      <span class="alert-icon">‚úì</span>
      <span>{{ success }}</span>
    </div>
    <div class="alert alert-error" *ngIf="error" [@fadeInOut] [class.access-denied]="accessDenied">
      <span class="alert-icon">‚úï</span>
      <span>{{ error }}</span>
    </div>
    
    <!-- Parent Access Denied Message -->
    <div *ngIf="isParent && accessDenied && studentBalance !== null && studentBalance > 0" 
         class="access-denied-card" 
         [@fadeInOut]>
      <div class="access-denied-icon">‚ö†Ô∏è</div>
      <h3>Report Card Access Restricted</h3>
      <p>
        Report card access is restricted. Please clear the outstanding balance of 
        <strong>{{ currencySymbol }} {{ studentBalance | number:'1.2-2' }}</strong> 
        to view the report card.
      </p>
    </div>
    
    <!-- Selection Form Card -->
    <div class="card selection-card">
      <div class="card-header">
        <h2>
          <span class="section-icon">üéØ</span>
          Generate Report Cards
        </h2>
        <p class="section-description">Select class and exam type to generate report cards</p>
      </div>

      <form (ngSubmit)="generateReportCards()">
        <div class="form-grid">
          <div class="form-group" *ngIf="!isParent; else parentClassDisplay" [class.has-error]="isFieldInvalid('class')">
            <label>
              Class <span class="required">*</span>
            </label>
            <select 
              [(ngModel)]="selectedClass" 
              name="class" 
              required
              [class.invalid]="isFieldInvalid('class')"
              class="form-control"
              (change)="onSelectionChange()">
              <option value="">Select Class</option>
              <option *ngFor="let class of classes" [value]="class.id">
                {{ class.name }}
              </option>
            </select>
            <div class="field-error" *ngIf="isFieldInvalid('class')">
              {{ getFieldError('class') }}
            </div>
          </div>

        <ng-template #parentClassDisplay>
          <div class="form-group">
            <label>
              Class
            </label>
            <div class="form-control readonly">
              {{ parentStudentClassName || 'Class information unavailable' }}
            </div>
            <div class="field-helper">
              Class is automatically selected based on the linked student.
            </div>
          </div>
        </ng-template>

          <div class="form-group" [class.has-error]="isFieldInvalid('term')">
            <label>
              Term <span class="required">*</span>
            </label>
            <select 
              [(ngModel)]="selectedTerm"
              name="term"
              required
              [disabled]="loadingTerms"
              [class.invalid]="isFieldInvalid('term')"
              class="form-control"
              (change)="onSelectionChange()">
              <option value="">{{ loadingTerms ? 'Loading terms...' : 'Select Term' }}</option>
              <option *ngFor="let term of availableTerms" [value]="term">
                {{ term }}
              </option>
            </select>
            <small style="color: #666; font-style: italic; display: block; margin-top: 5px;">
              {{ loadingTerms ? 'Loading term from settings...' : (selectedTerm ? 'Current term is automatically selected from system settings' : 'Please configure active term in settings') }}
            </small>
            <div class="field-error" *ngIf="loadingTerms">
              Loading term options...
            </div>
            <div class="field-error" *ngIf="!loadingTerms && isFieldInvalid('term')">
              {{ getFieldError('term') || 'Term is required' }}
            </div>
          </div>

          <div class="form-group" [class.has-error]="isFieldInvalid('examType')">
            <label>
              Exam Type <span class="required">*</span>
            </label>
            <select 
              [(ngModel)]="selectedExamType" 
              name="examType" 
              required
              [class.invalid]="isFieldInvalid('examType')"
              class="form-control"
              (change)="onSelectionChange()">
              <option value="">Select Exam Type</option>
              <option *ngFor="let type of examTypes" [value]="type.value">
                {{ type.label }}
              </option>
            </select>
            <div class="field-error" *ngIf="isFieldInvalid('examType')">
              {{ getFieldError('examType') }}
            </div>
          </div>

          <div class="form-group" *ngIf="!isParent" [class.has-error]="isFieldInvalid('subject')">
            <label>
              Subject <span class="required">*</span>
            </label>
            <select 
              [(ngModel)]="selectedSubjectId" 
              name="subject" 
              required
              [disabled]="!selectedClass || subjects.length === 0"
              [class.invalid]="isFieldInvalid('subject')"
              class="form-control"
              (change)="onSelectionChange()">
              <option value="">{{ selectedClass ? (subjects.length === 0 ? 'No subjects available' : 'Select Subject') : 'Select Class first' }}</option>
              <option *ngFor="let subject of subjects" [value]="subject.id">
                {{ subject.name }} ({{ subject.code }})
              </option>
            </select>
            <div class="field-error" *ngIf="isFieldInvalid('subject')">
              {{ getFieldError('subject') }}
            </div>
            <small *ngIf="selectedClass && subjects.length === 0 && !isAdmin && !isParent" style="color: #e74c3c; font-style: italic; display: block; margin-top: 5px;">
              No subjects assigned to you for this class. Please contact administrator.
            </small>
            <small *ngIf="selectedClass && subjects.length > 0 && !isAdmin && !isParent" style="color: #666; font-style: italic; display: block; margin-top: 5px;">
              Showing subjects you teach for this class
            </small>
          </div>
        </div>

        <div class="form-actions-inline">
          <button 
            type="submit" 
            class="btn btn-primary btn-generate" 
            [disabled]="loading || loadingTerms || !isSelectionValid()">
            <span *ngIf="!loading">
              üìÑ Generate Report Cards
            </span>
            <span *ngIf="loading" class="loading-content">
              <span class="spinner-small"></span>
              Generating...
            </span>
          </button>
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="resetSelection()"
            [disabled]="loading">
            üîÑ Reset
          </button>
        </div>
      </form>
    </div>

    <!-- Report Cards Section -->
    <div *ngIf="reportCards.length > 0" class="report-cards-section">
      <!-- Summary Statistics -->
      <div class="summary-card">
        <div class="summary-header">
          <h3>
            <span class="summary-icon">üìà</span>
            Report Cards Summary
          </h3>
        </div>
        <div class="summary-content">
          <div class="summary-item">
            <span class="summary-label">Class</span>
            <span class="summary-value">{{ classInfo?.name ? classInfo.name : 'N/A' }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Term</span>
            <span class="summary-value">{{ classInfo?.term ? classInfo.term : (selectedTerm || 'N/A') }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Exam Type</span>
            <span class="summary-value">{{ classInfo?.examType ? (classInfo.examType | titlecase) : 'N/A' }}</span>
          </div>
          <div class="summary-item highlight">
            <span class="summary-label">Total Report Cards</span>
            <span class="summary-value">{{ reportCards.length }}</span>
          </div>
          <div class="summary-item highlight">
            <span class="summary-label">Average Score</span>
            <span class="summary-value">{{ getOverallAverage() | number:'1.2-2' }}%</span>
          </div>
        </div>
      </div>

      <!-- Search and Filter Controls -->
      <div class="table-controls">
        <div class="search-box">
          <input 
            type="text" 
            [(ngModel)]="studentSearchQuery"
            [ngModelOptions]="{standalone: true}"
            placeholder="üîç Search students by name or ID..."
            class="search-input"
            (input)="filterReportCards()">
        </div>
        <div class="view-options">
          <button 
            class="btn btn-sm btn-secondary" 
            (click)="downloadAllPDFs()"
            [disabled]="loading || filteredReportCards.length === 0">
            üì• Download All PDFs
          </button>
        </div>
      </div>

      <!-- Report Cards List -->
      <div class="report-cards-list">
        <div 
          *ngFor="let reportCard of filteredReportCards; let i = index" 
          class="report-card-preview"
          [@fadeInUp]>
          <!-- Report Card Header -->
          <div class="report-card-header">
            <div class="report-card-number">
              <span class="number-badge">{{ i + 1 }}</span>
              <span class="total-count">of {{ filteredReportCards.length }}</span>
            </div>
            <div class="report-card-student-info">
              <h4>{{ reportCard.student.name }}</h4>
              <p>{{ reportCard.student.studentNumber }}</p>
            </div>
            <div class="report-card-actions">
              <button 
                type="button" 
                class="btn btn-primary btn-sm" 
                (click)="downloadPDF(reportCard)" 
                [disabled]="loading">
                üì• Download PDF
              </button>
            </div>
          </div>
          
          <!-- School Header -->
          <div *ngIf="reportCard.settings || schoolLogo || schoolLogo2" class="school-header">
            <div class="school-logo-wrapper school-logo-left" *ngIf="schoolLogo">
              <img [src]="schoolLogo" alt="School Logo" class="school-logo">
            </div>
            <div class="school-text">
              <h3 *ngIf="reportCard.settings?.schoolName">{{ reportCard.settings.schoolName }}</h3>
              <p *ngIf="reportCard.settings?.schoolAddress" class="school-address">
                {{ reportCard.settings.schoolAddress }}
              </p>
              <p *ngIf="reportCard.settings?.schoolPhone" class="school-phone">
                Phone: {{ reportCard.settings.schoolPhone }}
              </p>
              <p *ngIf="reportCard.settings?.academicYear" class="academic-year">
                Academic Year: {{ reportCard.settings.academicYear }}
              </p>
            </div>
            <div class="school-logo-wrapper school-logo-right" *ngIf="schoolLogo2">
              <img [src]="schoolLogo2" alt="School Logo 2" class="school-logo">
            </div>
          </div>

          <!-- Student Information -->
          <div class="student-info-grid">
            <div class="info-item">
              <span class="info-label">Student:</span>
              <span class="info-value">{{ reportCard.student.name }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Student Number:</span>
              <span class="info-value">{{ reportCard.student.studentNumber }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Class:</span>
              <span class="info-value">{{ reportCard.student.class }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Class Position:</span>
              <span class="info-value">
                {{ reportCard.classPosition ? reportCard.classPosition : 0 }} out of {{ reportCard.totalStudents ? reportCard.totalStudents : 0 }}
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Grade Position:</span>
              <span class="info-value">
                {{ reportCard.formPosition ? reportCard.formPosition : 0 }} out of {{ reportCard.totalStudentsPerStream ? reportCard.totalStudentsPerStream : 0 }}
              </span>
            </div>
            <div class="info-item" *ngIf="reportCard.totalAttendance !== undefined && reportCard.totalAttendance !== null">
              <span class="info-label">Total Attendance:</span>
              <span class="info-value">
                {{ reportCard.totalAttendance }} day{{ reportCard.totalAttendance !== 1 ? 's' : '' }}
                <span *ngIf="reportCard.presentAttendance !== undefined && reportCard.presentAttendance !== null">
                  (Present: {{ reportCard.presentAttendance }})
                </span>
              </span>
            </div>
            <div class="info-item">
              <span class="info-label">Exam Type:</span>
              <span class="info-value">{{ reportCard.examType | titlecase }}</span>
            </div>
            <div class="info-item full-width">
              <span class="info-label">Exams Included:</span>
              <span class="info-value">
                <span *ngFor="let exam of reportCard.exams; let i = index" class="exam-tag">
                  {{ exam.name }}<span *ngIf="i < reportCard.exams.length - 1">, </span>
                </span>
              </span>
            </div>
          </div>

          <!-- Subjects Table -->
          <div class="table-wrapper">
            <table class="report-table">
              <thead>
                <tr>
                  <th>Subject</th>
                  <th>Subject Code</th>
                  <th>Mark Obtained</th>
                  <th>Possible Mark</th>
                  <th>Class Average</th>
                  <th>Grade</th>
                  <th>Comments</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let subject of reportCard.subjects" [class.high-score]="subject.percentage >= 80" [class.low-score]="subject.percentage < 50">
                  <td class="subject-name">
                    <strong>{{ subject.subject }}</strong>
                  </td>
                  <td class="subject-code-cell">{{ subject.subjectCode || '-' }}</td>
                  <td class="score">{{ subject.score | number:'1.0-0' }}</td>
                  <td class="max-score">{{ subject.maxScore | number:'1.0-0' }}</td>
                  <td class="class-average">{{ subject.classAverage || 0 }}</td>
                  <td>
                    <span class="grade-badge grade-{{ subject.grade?.toLowerCase().replace(' ', '-') }}">
                      {{ subject.grade }}
                    </span>
                  </td>
                  <td class="comments">{{ subject.comments ? subject.comments : '-' }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Overall Performance -->
          <div class="performance-summary">
            <div class="performance-item">
              <span class="performance-label">Overall Average</span>
              <span class="performance-value highlight">{{ reportCard.overallAverage | number:'1.0-0' }}%</span>
            </div>
            <div class="performance-item">
              <span class="performance-label">Overall Grade</span>
              <span class="performance-value">
                <span class="grade-badge grade-{{ reportCard.overallGrade?.toLowerCase().replace(' ', '-') }}">
                  {{ reportCard.overallGrade }}
                </span>
              </span>
            </div>
          </div>

          <!-- Remarks Section -->
          <div class="remarks-section">
            <h3 class="remarks-title">Remarks</h3>
            
            <div class="remarks-item">
              <label class="remarks-label">
                Class Teacher Remarks
                <span *ngIf="!canEditRemarks" class="read-only-badge">Read-only</span>
              </label>
              <textarea 
                *ngIf="canEditRemarks"
                [(ngModel)]="reportCard.remarks.classTeacherRemarks" 
                name="classTeacherRemarks_{{reportCard.student.id}}"
                class="remarks-textarea"
                placeholder="Enter class teacher remarks..."
                rows="3"
                maxlength="500"></textarea>
              <div *ngIf="!canEditRemarks" class="remarks-readonly">
                {{ reportCard.remarks?.classTeacherRemarks ? reportCard.remarks.classTeacherRemarks : 'No remarks entered' }}
              </div>
            </div>

            <div class="remarks-item">
              <label class="remarks-label">
                Headmaster/Principal Remarks
                <span *ngIf="!authService.hasRole('admin')" class="read-only-badge">Read-only</span>
              </label>
              <textarea 
                *ngIf="authService.hasRole('admin')"
                [(ngModel)]="reportCard.remarks.headmasterRemarks" 
                name="headmasterRemarks_{{reportCard.student.id}}"
                class="remarks-textarea"
                placeholder="Enter headmaster/principal remarks..."
                rows="3"
                maxlength="500"></textarea>
              <div *ngIf="!authService.hasRole('admin')" class="remarks-readonly">
                {{ reportCard.remarks?.headmasterRemarks ? reportCard.remarks.headmasterRemarks : 'No remarks entered' }}
              </div>
            </div>

            <div *ngIf="canEditRemarks" class="remarks-actions">
              <button 
                type="button" 
                class="btn btn-primary" 
                (click)="saveRemarks(reportCard)" 
                [disabled]="savingRemarks">
                <span *ngIf="!savingRemarks">
                  üíæ Save Remarks for {{ reportCard.student.name }}
                </span>
                <span *ngIf="savingRemarks" class="loading-content">
                  <span class="spinner-small"></span>
                  Saving...
                </span>
              </button>
              <span *ngIf="reportCard.remarks?.id" class="saved-indicator">
                ‚úì Remarks saved
              </span>
            </div>
          </div>
          
          <!-- Navigation Hint -->
          <div *ngIf="i < filteredReportCards.length - 1" class="navigation-hint">
            <p>‚Üì Scroll down to view next student's report card ({{ filteredReportCards.length - i - 1 }} more) ‚Üì</p>
          </div>
        </div>
      </div>

      <!-- Empty Search State -->
      <div *ngIf="filteredReportCards.length === 0 && studentSearchQuery" class="empty-state-card">
        <span class="empty-icon">üîç</span>
        <h3>No report cards found</h3>
        <p>No report cards match your search criteria. Try adjusting your search.</p>
        <button class="btn btn-secondary" (click)="studentSearchQuery = ''; filterReportCards()">
          Clear Search
        </button>
      </div>

      <!-- Grade Scale Footer -->
      <div *ngIf="reportCards.length > 0 && gradeThresholds && gradeLabels" class="grade-scale-footer">
        <div class="grade-scale-header">
          <h3>üìä Grade Scale / Attainment Levels</h3>
        </div>
        <div class="grade-scale-grid">
          <div class="grade-scale-item">
            <span class="grade-range">90 ‚Äì 100</span>
            <span class="grade-label">{{ gradeLabels.excellent || 'OUTSTANDING' }}</span>
          </div>
          <div class="grade-scale-item">
            <span class="grade-range">80 ‚Äì 89</span>
            <span class="grade-label">{{ gradeLabels.veryGood || 'VERY HIGH' }}</span>
          </div>
          <div class="grade-scale-item">
            <span class="grade-range">60 ‚Äì 79</span>
            <span class="grade-label">{{ gradeLabels.good || 'HIGH' }}</span>
          </div>
          <div class="grade-scale-item">
            <span class="grade-range">40 ‚Äì 59</span>
            <span class="grade-label">{{ gradeLabels.satisfactory || 'GOOD' }}</span>
          </div>
          <div class="grade-scale-item">
            <span class="grade-range">20 ‚Äì 39</span>
            <span class="grade-label">{{ gradeLabels.needsImprovement || 'ASPIRING' }}</span>
          </div>
          <div class="grade-scale-item">
            <span class="grade-range">1 ‚Äì 19</span>
            <span class="grade-label">{{ gradeLabels.basic || 'BASIC' }}</span>
          </div>
          <div class="grade-scale-item">
            <span class="grade-range">0</span>
            <span class="grade-label">{{ gradeLabels.fail || 'UNCLASSIFIED' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && reportCards.length === 0 && !error" class="empty-state-card info">
      <span class="empty-icon">üìä</span>
      <h3>Ready to Generate Report Cards</h3>
      <p>Select a class and exam type above, then click "Generate Report Cards" to view student report cards.</p>
    </div>
  </div>
</div>
