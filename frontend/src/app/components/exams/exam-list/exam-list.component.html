<div class="container">
  <div class="exam-list-wrapper">
    <!-- Header Section -->
    <div class="form-header">
      <div class="header-content">
        <h1>
          <span class="icon">ğŸ“</span>
          Enter Marks
        </h1>
        <p class="subtitle">Enter and manage student exam marks</p>
      </div>
      <div style="display: flex; gap: 10px;" *ngIf="isAdmin">
        <button 
          class="btn btn-danger btn-icon" 
          (click)="deleteAllExams()" 
          [disabled]="loading || loadingStudents"
          title="Delete all exams">
          ğŸ—‘ï¸ Delete All
        </button>
        <button class="btn btn-primary btn-icon" routerLink="/exams/new" title="Create new exam">
          â• Create Exam
        </button>
      </div>
    </div>

    <!-- Alert Messages -->
    <div class="alert alert-success" *ngIf="success" [@fadeInOut]>
      <span class="alert-icon">âœ“</span>
      <span>{{ success }}</span>
    </div>
    <div class="alert alert-error" *ngIf="error" [@fadeInOut]>
      <span class="alert-icon">âœ•</span>
      <span>{{ error }}</span>
    </div>
    <div class="alert alert-info" *ngIf="isAutoSaving" [@fadeInOut] style="background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;">
      <span class="alert-icon">ğŸ’¾</span>
      <span>Auto-saving marks...</span>
    </div>

    <!-- Selection Form Card -->
    <div class="card selection-card">
      <div class="card-header">
        <h2>
          <span class="section-icon">ğŸ¯</span>
          Select Criteria
        </h2>
        <p class="section-description">Choose class, term, exam type, and subject to enter marks</p>
      </div>

      <div class="form-row-single">
        <div class="form-group" [class.has-error]="isFieldInvalid('class')">
          <label>
            Class <span class="required">*</span>
          </label>
          <select 
            [(ngModel)]="selectedClassId" 
            (change)="onSelectionChange()" 
            required
            [class.invalid]="isFieldInvalid('class')"
            class="form-control">
            <option value="">Select Class</option>
            <option *ngFor="let cls of classes" [value]="cls.id">{{ cls.name }}</option>
          </select>
          <div class="field-error" *ngIf="isFieldInvalid('class')">
            {{ getFieldError('class') }}
          </div>
        </div>

        <div class="form-group" [class.has-error]="isFieldInvalid('examType')">
          <label>
            Exam Type <span class="required">*</span>
          </label>
          <select 
            [(ngModel)]="selectedExamType" 
            (change)="onSelectionChange()" 
            required
            [class.invalid]="isFieldInvalid('examType')"
            class="form-control">
            <option value="">Select Exam Type</option>
            <option *ngFor="let examType of examTypes" [value]="examType.value">
              {{ examType.label }}
            </option>
          </select>
          <div class="field-error" *ngIf="isFieldInvalid('examType')">
            {{ getFieldError('examType') }}
          </div>
        </div>

        <div class="form-group" [class.has-error]="isFieldInvalid('subject')">
          <label>
            Subject <span class="required">*</span>
          </label>
          <select 
            [(ngModel)]="selectedSubjectId" 
            (change)="onSelectionChange()" 
            required
            [class.invalid]="isFieldInvalid('subject')"
            [disabled]="!selectedClassId || subjects.length === 0"
            class="form-control">
            <option value="">{{ selectedClassId ? (subjects.length === 0 ? 'No subjects available' : 'Select Subject') : 'Select Class first' }}</option>
            <option *ngFor="let subject of subjects" [value]="subject.id">
              {{ subject.name }} ({{ subject.code }})
            </option>
          </select>
          <div class="field-error" *ngIf="isFieldInvalid('subject')">
            {{ getFieldError('subject') }}
          </div>
        </div>

        <div class="form-group">
          <label>
            Term
          </label>
          <input 
            type="text" 
            [ngModel]="selectedTerm || (loadingTerm ? 'Loading...' : 'Not set')" 
            name="term" 
            readonly
            [disabled]="loadingTerm"
            class="form-control term-input">
          <small class="text-muted">Term is automatically set from system settings</small>
        </div>
      </div>

      <div class="form-actions-inline">
        <button 
          class="btn btn-primary btn-load" 
          (click)="loadStudents()" 
          [disabled]="!isSelectionValid() || loadingStudents">
          <span *ngIf="!loadingStudents">
            ğŸ” Load Students
          </span>
          <span *ngIf="loadingStudents" class="loading-content">
            <span class="spinner-small"></span>
            Loading...
          </span>
        </button>
        <button 
          class="btn btn-secondary" 
          (click)="resetSelection()"
          [disabled]="loadingStudents">
          ğŸ”„ Reset
        </button>
      </div>
    </div>

    <!-- Marks Entry Section -->
    <div *ngIf="showMarksEntry && students.length > 0" class="marks-entry-section">
      <!-- Summary Card -->
      <div class="summary-card">
        <div class="summary-header">
          <h3>
            <span class="summary-icon">ğŸ“Š</span>
            Marks Entry Summary
          </h3>
          <div *ngIf="isAdmin && showMarksEntry && isPublished" style="margin-left: auto;">
            <span class="status-badge" style="background-color: #28a745; color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold;">
              âœ“ Published
            </span>
          </div>
        </div>
        <div class="summary-content">
          <div class="summary-item">
            <span class="summary-label">Class:</span>
            <span class="summary-value">{{ getSelectedClassName() }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Term:</span>
            <span class="summary-value">{{ selectedTerm }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Exam Type:</span>
            <span class="summary-value">{{ getSelectedExamTypeLabel() }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Subject:</span>
            <span class="summary-value">{{ getSelectedSubjectName() }}</span>
          </div>
          <div class="summary-item highlight">
            <span class="summary-label">Total Students:</span>
            <span class="summary-value">{{ students.length }}</span>
          </div>
        </div>
        
        <!-- Marks Progress Indicator -->
        <div class="marks-progress-container">
          <div class="progress-line-top" [style.--progress-width.%]="getMarksProgress()"></div>
          <div class="progress-bar-main">
            <div class="progress-label-box">
              <span class="progress-label-text">{{ getEnteredMarksCount() }} / {{ students.length }} Marks Entered</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Search and Quick Actions -->
      <div class="table-controls">
        <div class="search-box">
          <input 
            type="text" 
            [(ngModel)]="studentSearchQuery"
            [ngModelOptions]="{standalone: true}"
            placeholder="ğŸ” Search students by name or ID..."
            class="search-input"
            (input)="filterStudents()">
        </div>
        <div class="quick-actions">
          <button 
            class="btn btn-sm btn-secondary" 
            (click)="clearAllMarks()"
            [disabled]="loading || getEnteredMarksCount() === 0 || isPublished">
            ğŸ—‘ï¸ Clear All
          </button>
          <button 
            class="btn btn-sm btn-secondary" 
            (click)="fillRemainingWithZero()"
            [disabled]="loading || isPublished">
            ğŸ”¢ Fill Empty with 0
          </button>
        </div>
      </div>

      <!-- Marks Entry Form -->
      <form (ngSubmit)="onSubmit()" class="marks-form">
        <div class="table-wrapper">
          <table class="marks-entry-table">
            <thead>
              <tr>
                <th style="width: 60px;">#</th>
                <th style="min-width: 120px;">Student ID</th>
                <th style="min-width: 150px;">Last Name</th>
                <th style="min-width: 150px;">First Name</th>
                <th style="min-width: 140px;">Marks</th>
                <th style="min-width: 200px;">Remarks</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let student of filteredStudents; let i = index" 
                  [class.has-marks]="hasMarks(student.id)"
                  [class.no-marks]="!hasMarks(student.id)">
                <td class="row-number">{{ i + 1 }}</td>
                <td>
                  <strong class="student-id">{{ student.studentNumber }}</strong>
                </td>
                <td>{{ student.lastName }}</td>
                <td>{{ student.firstName }}</td>
                <td>
                  <div class="marks-input-wrapper" style="position: relative;">
                    <input 
                      type="number" 
                      [(ngModel)]="marks[getMarkKey(student.id, selectedSubjectId)].score"
                      [name]="'score_' + student.id"
                      placeholder="0"
                      min="0"
                      max="100"
                      step="1"
                      class="marks-input"
                      [disabled]="isPublished"
                      [readonly]="isPublished"
                      (input)="onMarkChange(student.id)"
                      (blur)="validateMark(student.id); onStudentBlur(student.id)"
                      (focus)="onStudentFocus(student.id)">
                    <div class="save-status-indicator-mark" *ngIf="getSavingStatus(student.id)">
                      <span *ngIf="getSavingStatus(student.id) === 'saving'" class="saving-indicator">
                        <span class="spinner-small"></span>
                      </span>
                      <span *ngIf="getSavingStatus(student.id) === 'saved'" class="saved-indicator">
                        âœ“
                      </span>
                      <span *ngIf="getSavingStatus(student.id) === 'error'" class="error-indicator">
                        âœ—
                      </span>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="remarks-wrapper">
                    <div class="remarks-container">
                      <textarea 
                        [(ngModel)]="marks[getMarkKey(student.id, selectedSubjectId)].comments"
                        [name]="'comments_' + student.id"
                        [placeholder]="isGeneratingRemark(student.id) ? 'Generating AI remark...' : 'Enter remarks'"
                        class="remarks-input"
                        rows="2"
                        maxlength="200"
                        [disabled]="isPublished || isGeneratingRemark(student.id)"
                        [readonly]="isPublished || isGeneratingRemark(student.id)"
                        (input)="onCommentsChange(student.id)"
                        (blur)="onStudentBlur(student.id)"
                        (focus)="onStudentFocus(student.id)"></textarea>
                      <div class="ai-generating-indicator" *ngIf="isGeneratingRemark(student.id)" title="Generating AI remark...">
                        <span class="spinner-small"></span>
                        <span class="ai-text">AI</span>
                      </div>
                      <div class="save-status-indicator" *ngIf="getSavingStatus(student.id) && !isGeneratingRemark(student.id)">
                        <span *ngIf="getSavingStatus(student.id) === 'saving'" class="saving-indicator">
                          <span class="spinner-small"></span>
                        </span>
                        <span *ngIf="getSavingStatus(student.id) === 'saved'" class="saved-indicator">
                          âœ“
                        </span>
                        <span *ngIf="getSavingStatus(student.id) === 'error'" class="error-indicator">
                          âœ—
                        </span>
                      </div>
                    </div>
                    <button 
                      type="button"
                      class="cancel-student-btn"
                      (click)="cancelMarkAndRemark(student.id)"
                      [disabled]="isPublished"
                      title="Cancel mark and remark">
                      âŒ
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Statistics Footer -->
        <div class="marks-statistics">
          <div class="stat-item">
            <span class="stat-label">Total Students:</span>
            <span class="stat-value">{{ filteredStudents.length }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Marks Entered:</span>
            <span class="stat-value success">{{ getEnteredMarksCount() }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Pending:</span>
            <span class="stat-value warning">{{ filteredStudents.length - getEnteredMarksCount() }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Average Score:</span>
            <span class="stat-value">{{ getAverageScore() | number:'1.0-0' }}</span>
          </div>
        </div>

        <div *ngIf="isPublished" class="alert alert-info" style="margin-top: 15px; background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;">
          <span class="alert-icon">â„¹ï¸</span>
          <span>Results have been published. Editing is disabled. Students, parents, and teachers can now view these results.</span>
        </div>
      </form>
    </div>

    <!-- Empty States -->
    <div *ngIf="showMarksEntry && filteredStudents.length === 0 && !loadingStudents" class="empty-state-card">
      <span class="empty-icon">ğŸ”</span>
      <h3>No students found</h3>
      <p *ngIf="studentSearchQuery">No students match your search criteria. Try adjusting your search.</p>
      <p *ngIf="!studentSearchQuery">No students found in the selected class.</p>
      <button class="btn btn-secondary" (click)="studentSearchQuery = ''; filterStudents()" *ngIf="studentSearchQuery">
        Clear Search
      </button>
    </div>

    <div *ngIf="!showMarksEntry && !loadingStudents" class="empty-state-card info">
      <span class="empty-icon">ğŸ“</span>
      <h3>Ready to Enter Marks</h3>
      <p>Select a class, term, exam type, and subject above, then click "Load Students" to begin entering marks.</p>
    </div>
  </div>
</div>
